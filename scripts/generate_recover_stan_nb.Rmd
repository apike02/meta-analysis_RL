---
title: "Generate and recover notebook: STAN"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

Libraries
```{r}
rm(list=ls())

library('R.matlab')
#library('cmdstanr')
library('ggplot2')
library('dplyr')
library('patchwork')

workingdir='C:/Users/apike/OneDrive - University College London/metaRL/'
datadir='C:/Users/apike/OneDrive - University College London/metaRL/generate_recover/'
scriptdir='C:/Users/apike/OneDrive - University College London/metaRL/scripts/'
modeldir='C:/Users/apike/OneDrive - University College London/metaRL/scripts/models/'
ntrials=200
```

Model

```{r}
model1='1lr1t1d1p'
directory=paste0(workingdir,'generate_recover/',model1)
```



Generate parameters

```{r}
#don't run if you don't want to generate new parameters! can load in saved ones later if that's preferred.

n=1000 #number of 'agents' you want to create

alpha<-rbeta(n,1,1)

alphaloss<-rbeta(n,1,1)
  
beta<-rgamma(n,5,1)
  
betaloss<-rgamma(n,5,1)

rewsens<-rgamma(n,3,1)

punsens<-rgamma(n,3,1)

lapse<-rbeta(n,0.5,1.5)

gobias<-rgamma(n,3,1)

appbias<-rgamma(n,3,1)

avbias<-rgamma(n,3,1)

decay<-rbeta(n,1,1)

perseverance<-rnorm(n, 0, sqrt(5))

hist(alpha)
hist(alphaloss)
hist(beta)
hist(betaloss)
hist(rewsens)
hist(punsens)
hist(lapse)
hist(gobias)
hist(appbias)
hist(avbias)
hist(decay)
hist(perseverance)

generated_parameters=list(alpha=alpha, alphaloss=alphaloss, beta=beta, betaloss=betaloss, rewsens=rewsens, punsens=punsens, lapse=lapse, gobias=gobias, appbias=appbias, avbias=avbias, decay=decay, perseverance=perseverance)

save(generated_parameters, file=paste0(directory,'/generated_params'))
```

Load generated parameters
```{r}
load(paste0(directory,'/generated_params'))
ntrials<-200
n=500
```

Generate synthetic data 
```{r}
source(paste0(workingdir,'/scripts/gen_rec_dataonly.R'))
source(paste0(workingdir,'/scripts/stanify_data.R'))
source(paste0(workingdir,'/scripts/stanify_data_gng.R'))



tasklist<-c('task5')
for (t in tasklist){
  if (t=='task5') {
    gng=1
    name_var<-
    c('study','pat_con','id','trial','stim','go_outcome','choices')
  } else {
    gng=0
    name_var<-
    c('study','pat_con','id','trial','reward','pun','choices')
  }
  taskname_short<-paste0('t',str_sub(t,5,5))
  dir.create(directory)
  taskname<-load(paste0(workingdir,'/tasks/',t))
  task<-get(taskname)
  data<-gen_rec_dataonly(n,task,model1,taskname_short,gng,workingdir)
  save(data,file=paste0(directory,'/data_',taskname_short))
  data<-as.data.frame(data)
  colnames(data)<-name_var
  data<-transform(data,fullid=paste(study,id,sep='.'))
  data$study<-as.numeric(data$study)
  data$fullid<-rep(seq(1:length(unique(data$fullid))),each=ntrials)
  write.csv(data,paste0(directory,'/data_',taskname_short,'.csv'))
  if (gng==1){
    stanify_data_gng(taskname_short,directory)
  } else {
    stanify_data(taskname_short,directory)

  }
}
```

Now run using vb
```{r}
library('rstan')

for (t in tasklist){
  
  taskname_short<-paste0('t',str_sub(t,5,5))
  
  if (t=='task5'){
    stanname=paste0('metaRL_',model1,'_gng.stan')
  } else {
    stanname=paste0('metaRL_',model1,'.stan')
  }
  
  data<-load(paste0(directory,'/con_data_',taskname_short,'.RData'))
  data<-get(data)
  stanfile <- paste0(modeldir,stanname)

  model<-stan_model(stanfile)
  fit<-vb(model,data=data,tol_rel_obj=0.001)

  saveRDS(fit,file = paste0(directory,'/fit_',taskname_short,'.RDS'))
  
}

#model<-cmdstan_model(stanfile)
#fit_t1 <- model$sample(data = con_data_t1)
#fit_t1$save_object(file=file.path(datadir,model1,'/fit_t1.RDS'))
```

Analyse results for genrec
```{r}
source(paste0(scriptdir,'/analyse_recoverability_vb_rstan.R'))

for (task in 1:5){
  taskname<-paste0('t',task)
  fit<-readRDS(file=paste0(directory,'/fit_',taskname,'.RDS'))
  
  source(paste0(workingdir,'/scripts/confusion_matrix.R'))
  
  params<-analyse_recoverability_vb(model1,ntrials,taskname)
  original<-do.call(cbind,lapply(params,function(x) x[,1]))
  estimated<-do.call(cbind,lapply(params,function(x) x[,2]))
  colnames(original)<-lapply(params, function(x) gsub("[[:digit:]]","",rownames(x)[1])) #gets column names
  colnames(estimated)<-colnames(original)
  task_matrix<-confusion_matrix(original,estimated,paramnames=c('learning rate','inverse temperature', 'decay','perseverance'))+
    labs(title=paste0('Task ',task))
  assign(paste0(taskname,'_matrix'),task_matrix)
  ggsave(paste0(datadir,model1,'/',taskname,'_confusion_matrix.png'),task_matrix)
  
}


```

Create overall figure


```{r}

t1_matrix + t2_matrix + guide_area() + t3_matrix + t4_matrix + t5_matrix + plot_layout(guides='collect',ncol=3) + plot_annotation(tag_levels='A') & theme(legend.position='right')

ggsave(file=paste0(workingdir,'/figures/overall_confusion_matrix_vba_',model1,'.png'),scale=1.5,width=10,height=7)
```
Create figure to make task point

```{r}
correlations<-list()
tasklist<-c('t1','t2','t3','t4','t5')
paramnames<-c('reward learning rate','punishment learning rate', 'sensitivity')

for (t in 1:length(tasklist)){
  taskname<-paste0('t',t)
  fit<-readRDS(file=paste0(datadir,model,'/fit_',taskname,'.RDS'))
  source(paste0(workingdir,'/scripts/confusion_matrix.R'))
  params<-analyse_recoverability_vb(model,ntrials,taskname)
  original<-do.call(cbind,lapply(params,function(x) x[,1]))
  estimated<-do.call(cbind,lapply(params,function(x) x[,2]))
  correlations[[t]]<-diag(cor(original,estimated))
  names(correlations[[t]])<-paramnames
}

correlations<-bind_rows(correlations,.id='Task')%>%
  pivot_longer(cols=all_of(paramnames),names_to='Parameter',values_to='Recovery')

ggplot(correlations[correlations$Parameter!='sensitivity',],aes(x=Task,y=Recovery))+
  geom_point(aes(colour=Parameter,shape=Parameter))+
  stat_summary(geom='pointrange',fun.data='mean_se',position=position_nudge(x=0.2))+
  theme_classic()+
  ylim(c(0,1))

ggsave(file=paste0(workingdir,'/figures/recovery_correlations.png'),scale=0.9,width=10,height=7)

```

